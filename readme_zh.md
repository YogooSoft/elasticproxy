# ElasticProxyServer 功能介绍文档

[![Java](https://img.shields.io/badge/Java-17+-blue.svg)](https://openjdk.java.net/projects/jdk/17/)
[![Spring Boot](https://img.shields.io/badge/Spring%20Boot-3.3.2-brightgreen.svg)](https://spring.io/projects/spring-boot)
[![Version](https://img.shields.io/badge/版本-v1.5.3-orange.svg)](https://github.com/your-repo/ElasticProxyServer)
[![License](https://img.shields.io/badge/License-企业内部-red.svg)]()

## 📋 项目概述

**ElasticProxyServer** 是一个基于 Java 17 + Spring Boot WebFlux 构建的企业级 Elasticsearch 透明代理服务器，提供完整的代理转发、安全控制、多租户支持、监控审计等高级功能。采用响应式编程模型，支持高并发、低延迟的数据访问场景。

### 🎯 核心价值

- **🛡️ 企业级安全** - 7大类搜索保护指标，全方位、多层安全防护，保障集群安全
- **🏢 多租户架构** - 完全隔离的多租户支持
- **⚡ 高性能代理** - 基于WebFlux的非阻塞响应式架构
- **🔍 智能查询** - 统一搜索API，简化复杂查询操作
- **📊 全面监控** - 企业级监控审计和性能分析
- **🔄 零停机运维** - 配置热重载和故障自愈能力

---

## 🏗️ 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    ElasticProxyServer                        │
├─────────────────────────────────────────────────────────────┤
│  客户端请求  │
│      ↓      │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │              Web过滤器链 (WebFlux)                    │ │
│ │  IP访问控制 → 限流控制 → 租户认证 → 请求日志           │ │
│ └─────────────────────────────────────────────────────────┘ │
│      ↓      │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                   路由处理层                          │ │
│ │  统一搜索API  │  透明代理  │  跨集群搜索  │  管理端点   │ │
│ └─────────────────────────────────────────────────────────┘ │
│      ↓      │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                 查询分析与安全                          │ │
│ │  查询复杂度分析  │  权限验证  │  索引访问控制           │ │
│ └─────────────────────────────────────────────────────────┘ │
│      ↓      │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │               后端连接管理                              │ │
│ │  ES集群连接池  │  故障转移  │  负载均衡  │  租户隔离   │ │
│ └─────────────────────────────────────────────────────────┘ │
│      ↓      │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                监控与审计                               │ │
│ │  性能监控  │  查询日志  │  安全审计  │  指标收集        │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
           ↓
    Elasticsearch 集群
```

### 技术栈

| 组件类别 | 技术选型 | 版本 | 用途说明 |
|---------|---------|------|---------|
| **基础框架** | Spring Boot | 3.3.2 | 应用基础框架 |
| **Web框架** | Spring WebFlux | - | 响应式Web框架 |
| **网络层** | Reactor Netty | - | 非阻塞网络通信 |
| **缓存** | Caffeine | 3.1.8 | 高性能内存缓存 |
| **限流** | Bucket4j | 8.9.0 | 令牌桶限流算法 |
| **监控** | Micrometer | - | 应用指标监控 |
| **ES客户端** | Elasticsearch Java Client | 8.11.4 | ES连接与操作 |
| **配置管理** | Spring Cloud | 2023.0.4 | 配置热重载支持 |
| **构建工具** | Maven | 3.x | 项目构建管理 |

---

## 🚀 核心功能特性

### 1. 🛡️ 企业级安全控制

#### IP访问控制
- **CIDR网段支持**: 完整支持IPv4/IPv6 CIDR格式（如`192.168.1.0/24`）
- **白名单/黑名单**: 灵活的访问控制策略
- **动态更新**: 支持配置热重载，无需重启服务

```yaml
proxy:
  allowList: ["127.0.0.1", "10.0.0.0/24", "192.168.0.0/16"]
  blockList: ["192.168.100.0/24"]  # 阻断特定网段
```

#### 智能限流系统
- **令牌桶算法**: 基于Bucket4j的高性能限流
- **多时间维度**: 支持秒级、分钟级、小时级限流
- **客户端隔离**: 按IP地址独立计算限流配额

```yaml
proxy:
  limits:
    rateLimit: 100/minute  # 每分钟100次请求
```

#### 查询安全分析
- **复杂度评估**: 智能分析查询复杂度，防止资源滥用
- **深度限制**: 控制查询DSL嵌套深度，避免堆栈溢出
- **危险查询拦截**: 自动识别并阻止前缀通配符、正则表达式等高风险查询

### 2. 🏢 多租户架构支持

#### 完全租户隔离
- **独立认证**: 每个租户使用专属的HTTP Basic认证凭据
- **后端隔离**: 租户专属的Elasticsearch连接池和凭据
- **权限隔离**: 租户级别的索引访问控制和操作限制

```yaml
proxy:
  multi-tenant:
    enabled: true
    tenants:
      tenant-logs:
        name: "日志分析租户"
        basicAuth:
          username: "logs-user"
          password: "logs-secret-2024"
        allowedIps: ["10.1.0.0/24", "192.168.1.0/24"]
        elasticsearch:
          cluster: "logs"
        limits:
          allowedIndices: ["logs-*", "app-logs-*"]
```

#### 高性能多租户实现
- **智能缓存**: 租户上下文缓存（15分钟TTL）
- **连接池管理**: 每个租户独立的WebClient连接池
- **配置继承**: 租户可继承全局配置，按需覆盖特定设置

### 3. 🔍 统一搜索API

#### 智能查询简化
将复杂的Elasticsearch DSL查询简化为直观的JSON条件组合：

**传统ES查询**:
```json
{
  "query": {
    "bool": {
      "filter": [
        {"term": {"orderId": "ORDER_12345"}},
        {"range": {"date": {"gte": "2023-01-01", "lt": "2023-12-31"}}},
        {"match": {"description": "iPhone 手机"}}
      ]
    }
  }
}
```

**统一搜索API**:
```json
{
  "conditions": [
    {"key": "orderId", "value": "ORDER_12345"},
    {"key": "date", "value": "2023-01-01,2023-12-31"},
    {"key": "description", "value": "iPhone 手机"}
  ],
  "relationshipType": "AND"
}
```

#### 智能类型识别
- **自动推断**: 根据字段名和值格式自动识别查询类型
- **精确匹配**: 订单号、用户ID等标识符自动使用Term查询
- **范围查询**: 日期、价格等数值自动支持范围筛选
- **文本搜索**: 描述、评论等内容自动启用分词搜索

#### 查询结果缓存
- **高性能缓存**: 基于Caffeine的内存缓存，响应时间提升80-95%
- **智能缓存键**: 基于索引路径、查询条件、分页参数生成MD5哈希
- **缓存管理**: 支持TTL设置、最大条目限制、手动清理

### 4. 🌐 跨集群搜索支持

#### CCS别名路由
- **集群别名**: 支持通过别名访问不同ES集群
- **透明路由**: 自动将`/logs:index-*/_search`路由到logs集群
- **Scroll支持**: 完整支持跨集群的scroll操作

```yaml
elasticsearch:
  clusters:
    logs:
      url: http://es-logs:9200
      username: "elastic"
      password: "secret"
    metrics:
      url: http://es-metrics:9200
      username: "elastic" 
      password: "secret"
```

#### Scroll操作增强
- **自动跟踪**: 智能跟踪scroll_id与集群的映射关系
- **透明操作**: 后续scroll请求自动路由到正确集群
- **内存管理**: 内置清理机制防止内存泄漏

### 5. ⚡ 高可用性支持

#### 故障转移机制
- **多节点支持**: 自动检测和切换ES节点
- **智能重试**: 指数退避重试算法
- **健康检测**: 实时监控节点状态

```yaml
elasticsearch:
  url: http://node1:9200,http://node2:9200  # 多节点配置
```

#### 连接池优化
- **可配置参数**: 连接数、超时时间、空闲时长等全面可调
- **性能调优**: 支持运行时连接池参数调整

### 6. 📊 全面监控审计

#### ES监控日志集成
- **异步写入**: 非阻塞的ES日志写入，不影响主请求性能
- **按日索引**: 自动创建`elastic-proxy-logs-YYYY-MM-DD`索引
- **完整记录**: 包含请求详情、查询分析、性能指标

```json
{
  "requestId": "550e8400-e29b-41d4-a716-446655440000",
  "timestamp": "2025-10-25T10:30:45.123Z",
  "clientIp": "192.168.1.100",
  "method": "POST",
  "path": "/test1/_search",
  "statusCode": 200,
  "duration": 156,
  "queryAnalysis": {
    "allowed": true,
    "analysis": {
      "complexity": 48,
      "depth": 4,
      "aggregations": "passed"
    }
  }
}
```

#### 多租户监控增强
- **租户标识**: 所有监控数据包含完整租户信息
- **双写模式**: 支持租户专属索引 + 全局索引双写
- **审计追踪**: 完整的租户操作审计链

#### 性能指标收集
- **Prometheus集成**: 标准化的指标暴露
- **实时监控**: 响应时间、请求计数、错误率等关键指标
- **自定义指标**: 支持业务相关的自定义监控指标

### 7. 🔄 运维友好特性

#### 配置热重载
- **零停机更新**: 通过`/actuator/refresh`端点更新配置
- **全组件支持**: 所有配置项均支持热重载
- **缓存清理**: 配置更新时自动清理相关缓存

```bash
# 修改配置后触发热重载
curl -X POST http://localhost:8000/actuator/refresh
```

#### 健康检查
- **多维度检查**: ES连接、服务状态、资源使用等
- **探针支持**: 支持Kubernetes liveness/readiness探针
- **详细诊断**: 提供详细的健康状态信息

#### 管理端点
- **Actuator集成**: 完整的Spring Boot Actuator支持
- **租户管理**: 专门的租户配置查询和连接测试端点
- **缓存管理**: 统一搜索缓存统计和清理端点

---

## 📈 性能特性

### 响应式架构优势

| 特性 | 传统同步架构 | WebFlux响应式架构 | 性能提升 |
|------|-------------|------------------|---------|
| **并发处理** | 线程池限制 | 事件驱动，无线程阻塞 | 10-20x |
| **内存使用** | 每连接一线程 | 共享事件循环 | 5-10x优化 |
| **延迟** | I/O阻塞延迟 | 非阻塞异步处理 | 50-80%降低 |
| **吞吐量** | 受线程数限制 | CPU密集型扩展 | 3-5x提升 |

### 缓存性能优化

- **查询缓存**: 60-80%缓存命中率，响应时间提升80-95%
- **租户缓存**: 15分钟TTL，避免重复认证开销
- **连接池**: 复用长连接，减少连接建立开销

### 监控性能影响

- **监控开销**: <1% CPU，<10MB 内存
- **日志记录**: 异步处理，零阻塞
- **指标收集**: 内存高效的计数器和直方图

---

## 🛠️ 部署与配置

### 快速启动

```bash
# 1. 构建应用
mvn -DskipTests clean package

# 2. 启动服务
java -jar target/elasticproxy-server-1.5.3.jar \
  --server.port=8000 \
  --elasticsearch.url=http://localhost:9200
```

### Docker部署

```bash
# 标准模式
./start-docker.sh standard -d

# 多租户模式
./start-docker.sh multi-tenant -d
```

### 核心配置示例

```yaml
server:
  port: 8000

elasticsearch:
  url: http://localhost:9200
  username: "elastic"
  password: "secret"
  requestTimeoutSeconds: 30

proxy:
  useElasticsearchMonitoring: true
  allowList: ["127.0.0.1", "10.0.0.0/24"]
  limits:
    rateLimit: 100/minute
    maxResultWindow: 10000
    maxQueryDepth: 5
  
  unified-search:
    enabled: true
    enableQueryCache: true
    queryCacheTtlSeconds: 300
    allowedIndices: ["logs-*", "metrics-*"]
    
  multi-tenant:
    enabled: false  # 默认关闭
```

---

## 📋 使用场景

### 1. 企业数据中台
- **统一数据访问**: 为不同业务线提供统一的ES访问接口
- **安全合规**: 满足企业级安全和审计要求
- **性能优化**: 通过缓存和查询优化提升数据访问效率

### 2. SaaS多租户平台
- **租户隔离**: 完全独立的租户数据访问控制
- **资源管控**: 按租户进行资源使用限制和监控
- **灵活计费**: 基于监控数据进行租户使用量计费

### 3. 数据安全网关
- **查询防护**: 防止恶意查询影响ES集群性能
- **访问审计**: 完整的数据访问审计轨迹
- **权限管控**: 细粒度的数据访问权限控制

### 4. 开发测试环境
- **简化查询**: 通过统一搜索API降低开发门槛
- **环境隔离**: 不同环境的ES访问隔离
- **调试支持**: 详细的查询日志和性能分析

---

## 🔮 发展路线图

### v1.6.0 规划功能
- **数据脱敏**: 敏感数据自动脱敏处理
- **查询优化**: AI驱动的查询性能优化建议
- **插件系统**: 可扩展的插件架构

---

## 🤝 技术支持

### 版本信息
- **当前版本**: v1.5.3
- **Java版本**: 17+
- **Spring Boot**: 3.3.2
- **最低ES版本**: 7.0+

### 兼容性保证
- ✅ **向后兼容**: 所有新功能默认关闭，不影响现有部署
- ✅ **渐进升级**: 支持分阶段启用新功能
- ✅ **零停机运维**: 配置热重载和平滑升级

### 企业支持
- 🔧 **技术咨询**: 架构设计和性能优化建议
- 📊 **监控集成**: 与企业现有监控系统集成
- 🎓 **培训服务**: 团队技能培训和最佳实践分享
- 🚀 **定制开发**: 根据业务需求定制功能模块

### 更多信息
- 🌐 **详情可以访问 elasticproxy.com 网站**

---

**ElasticProxyServer - 让Elasticsearch访问更安全、更智能、更高效！** 🚀
